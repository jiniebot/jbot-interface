<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Dashboard - JinieBot</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster/dist/MarkerCluster.Default.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/dashboard-ios.css">
    <link rel="stylesheet" href="/css/responsive-base.css">
    <link rel="stylesheet" href="/css/dashboard-mobile.css">
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster/dist/leaflet.markercluster.js"></script>
</head>
<body>
    <!-- Top Control Bar -->
    <!-- Global Loading Overlay -->
    <div id="page-loading-overlay" class="loading-overlay hidden">
        <div class="loading-content">
            <div class="ios-spinner"></div>
            <div class="loading-text">Loading data...</div>
        </div>
    </div>

    <div id="top-controls">
        <!-- Left Controls -->
        <div class="control-group left-controls">
            <button class="control-btn" id="toggleLeftPanel" title="Toggle Info Panel">
                <span>â„¹ï¸</span>
            </button>
            <button class="control-btn" id="filterBtn" title="Filter Markers">
                <span>ğŸ”</span>
            </button>
        </div>

        <!-- Center Controls -->
        <div class="control-group center-controls">
            <button class="control-btn" id="zoomIn" title="Zoom In">
                <span>+</span>
            </button>
            <button class="control-btn" id="zoomOut" title="Zoom Out">
                <span>âˆ’</span>
            </button>
            <button class="control-btn" id="mapViewToggle" title="Toggle Map View">
                <span>ğŸ—ºï¸</span>
            </button>
        </div>

        <!-- Right Controls -->
        <div class="control-group right-controls">
            <button class="control-btn" id="toggleDrawingPanel" title="Toggle Drawing Panel">
                <span>ğŸ–Šï¸</span>
            </button>
            <button class="control-btn" id="toggleRightPanel" title="Toggle Actions Panel">
                <span>âš™ï¸</span>
            </button>
            <button class="control-btn menu-button" id="menuButton" title="Menu">
                <span>â‹¯</span>
            </button>
        </div>
    </div>

    <!-- Filter Panel -->
    <div id="filterPanel" class="filter-panel">
        <div class="filter-header">
            <h3>Map Filters</h3>
            <button class="filter-close" id="filterCloseBtn">âœ•</button>
        </div>
        <div class="filter-content">
            <div class="filter-section">
                <label class="filter-toggle">
                    <input type="checkbox" id="toggleRecentPlayers" checked>
                    <span class="filter-icon">ğŸ‘¤</span>
                    <span class="filter-label">Recent Players</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" id="toggleBases" checked>
                    <span class="filter-icon">ğŸ´</span>
                    <span class="filter-label">Bases</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" id="toggleActiveZones" checked>
                    <span class="filter-icon">ğŸŸ¢</span>
                    <span class="filter-label">Active Zones</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" id="toggleInactiveZones" checked>
                    <span class="filter-icon">ğŸ”´</span>
                    <span class="filter-label">Inactive Zones</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" id="toggleActiveObjs" checked>
                    <span class="filter-icon">ğŸ“¦</span>
                    <span class="filter-label">Spawned Objects</span>
                </label>
            </div>
            <div class="filter-divider"></div>
            <div class="filter-section">
                <h4 class="filter-section-title">Map Markers</h4>
                <label class="filter-toggle">
                    <input type="checkbox" class="category-item" data-type="Capital">
                    <span class="filter-icon">ğŸ›ï¸</span>
                    <span class="filter-label">Capitals</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" class="category-item" data-type="City" checked>
                    <span class="filter-icon">ğŸ™ï¸</span>
                    <span class="filter-label">Cities</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" class="category-item" data-type="Village">
                    <span class="filter-icon">ğŸ˜ï¸</span>
                    <span class="filter-label">Villages</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" class="category-item" data-type="Local">
                    <span class="filter-icon">ğŸ </span>
                    <span class="filter-label">Local</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" class="category-item" data-type="Camp">
                    <span class="filter-icon">â›º</span>
                    <span class="filter-label">Camps</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" class="category-item" data-type="Hill">
                    <span class="filter-icon">â›°ï¸</span>
                    <span class="filter-label">Hills</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" class="category-item" data-type="RailroadStation">
                    <span class="filter-icon">ğŸš‚</span>
                    <span class="filter-label">Railroad Stations</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" class="category-item" data-type="Marine">
                    <span class="filter-icon">âš“</span>
                    <span class="filter-label">Marine</span>
                </label>
                <label class="filter-toggle">
                    <input type="checkbox" class="category-item" data-type="Ruin">
                    <span class="filter-icon">ğŸšï¸</span>
                    <span class="filter-label">Ruins</span>
                </label>
            </div>
        </div>
    </div>

    <!-- Global Menu Dropdown -->
    <div id="global-menu" class="menu-dropdown">
        <a href="/dashboard" class="menu-item" id="menuMapDashboard">
            <div class="menu-item-icon">ğŸ—ºï¸</div>
            <span class="menu-item-text">Map Dashboard</span>
        </a>
        <a href="/dashboard/store" class="menu-item" id="menuStoreManagement">
            <div class="menu-item-icon">ğŸ›’</div>
            <span class="menu-item-text">Store Management</span>
        </a>
        <div class="menu-divider"></div>
        <a href="/selectGuildService" class="menu-item" id="menuChangeServer">
            <div class="menu-item-icon">ğŸ”„</div>
            <span class="menu-item-text">Change Server</span>
        </a>
        <a href="/settings" class="menu-item" id="menuAccountSettings">
            <div class="menu-item-icon">âš™ï¸</div>
            <span class="menu-item-text">Account Settings</span>
        </a>
        <div class="menu-divider"></div>
        <a href="/auth/logout" class="menu-item">
            <div class="menu-item-icon">ğŸšª</div>
            <span class="menu-item-text">Logout</span>
        </a>
    </div>

    <!-- Left Panel -->
    <div id="left-panel" class="floating-panel collapsed">
        <div class="panel-header">
            <div class="panel-title">Information</div>
            <div class="panel-toggle" id="leftPanelToggle">+</div>
        </div>
        <div class="panel-content hidden" id="leftPanelContent">
            <div id="selection-info">
                <p style="text-align: center; color: #8E8E93; margin-top: 40px;">
                    Click on a map marker to view details
                </p>
            </div>
        </div>
    </div>

    <!-- Right Panel -->
    <div id="right-panel" class="floating-panel collapsed">
        <div class="panel-header">
            <div class="panel-title">Actions</div>
            <div class="panel-toggle" id="rightPanelToggle">+</div>
        </div>
        <div class="panel-content hidden" id="rightPanelContent">
            <div id="action-buttons">
                <p style="text-align: center; color: #8E8E93; margin-top: 40px;">
                    Select an item to see available actions
                </p>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div id="dashboard-container">
        <div id="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Bottom Toolbar -->
    <div id="bottom-toolbar">
        <a href="/quests" class="toolbar-item">
            <div class="toolbar-icon">ğŸ“œ</div>
            <div class="toolbar-label">Quests</div>
        </a>
        <a href="/factions" class="toolbar-item">
            <div class="toolbar-icon">âš”ï¸</div>
            <div class="toolbar-label">Factions</div>
        </a>
        <a href="/dashboard/store" class="toolbar-item">
            <div class="toolbar-icon">ğŸ›’</div>
            <div class="toolbar-label">Store</div>
        </a>
        <a href="/dashboard" class="toolbar-item active">
            <div class="toolbar-icon">ğŸ—ºï¸</div>
            <div class="toolbar-label">Map</div>
        </a>
        <a href="/spawner-queue" class="toolbar-item">
            <div class="toolbar-icon">ğŸ”„</div>
            <div class="toolbar-label">Queue</div>
        </a>
        <a href="/logs" class="toolbar-item">
            <div class="toolbar-icon">ğŸ“‹</div>
            <div class="toolbar-label">Logs</div>
        </a>
        <a href="/settings" class="toolbar-item">
            <div class="toolbar-icon">âš™ï¸</div>
            <div class="toolbar-label">Settings</div>
        </a>
    </div>

    <!-- Dashboard JavaScript -->
    <script type="module" src="/js/dashboardMain.js?v=<%= Date.now() %>"></script>
    <script>
        // Side-specific close helpers: ensure only one UI element per side is open
        function closeLeftSidePanels() {
            // Left side: either the floating left panel or the filter panel
            const filter = document.getElementById('filterPanel');
            if (filter) filter.classList.remove('show');

            const leftPanel = document.getElementById('left-panel');
            if (leftPanel && !leftPanel.classList.contains('collapsed')) {
                leftPanel.classList.add('collapsed');
                document.getElementById('leftPanelContent')?.classList.add('hidden');
                leftPanel.querySelector('.panel-toggle').textContent = '+';
            }
        }

        function closeRightSidePanels() {
            // Right side: either the floating right panel or the global menu
            const menu = document.getElementById('global-menu');
            if (menu) menu.classList.remove('show');

            const rightPanel = document.getElementById('right-panel');
            if (rightPanel && !rightPanel.classList.contains('collapsed')) {
                rightPanel.classList.add('collapsed');
                document.getElementById('rightPanelContent')?.classList.add('hidden');
                rightPanel.querySelector('.panel-toggle').textContent = '+';
            }
        }

        // Global Menu Toggle (right side). Only one right-side menu visible at a time.
        // Align the top-right corner of the global menu with the top-right corner of the actions (right) panel.
        function toggleMenu() {
            const menu = document.getElementById('global-menu');
            const wasOpen = menu.classList.contains('show');

            // Close other right-side UI first
            closeRightSidePanels();

            // Toggle this menu and position it aligned to the right panel's top-right corner
            if (!wasOpen) {
                // Temporarily show so offsetWidth is measurable
                menu.classList.add('show');

                try {
                    const rightPanel = document.getElementById('right-panel');
                    if (rightPanel) {
                        const rect = rightPanel.getBoundingClientRect();
                        // Set menu top to match panel top, and right to match panel right
                        const top = Math.max(8, rect.top);
                        const right = Math.max(8, window.innerWidth - rect.right);

                        menu.style.position = 'fixed';
                        menu.style.top = `${top}px`;
                        menu.style.right = `${right}px`;
                        menu.style.left = 'auto';
                    }
                } catch (err) {
                    // If anything fails, leave default CSS positioning
                }
            }
        }


        // Close menus/panels when clicking outside (respecting side separation)
        document.addEventListener('click', (e) => {
            const menu = document.getElementById('global-menu');
            const menuButton = document.querySelector('.menu-button');
            if (menu && !menu.contains(e.target) && !menuButton.contains(e.target) && menu.classList.contains('show')) {
                menu.classList.remove('show');
            }

            const filterPanel = document.getElementById('filterPanel');
            const filterButton = document.getElementById('filterBtn');
            if (filterPanel && !filterPanel.contains(e.target) && !filterButton.contains(e.target) && filterPanel.classList.contains('show')) {
                filterPanel.classList.remove('show');
            }
        });

        // Prevent clicks inside the global menu from bubbling to document (which closes menus)
        document.getElementById('global-menu')?.addEventListener('click', (e) => {
            e.stopPropagation();
        });

        // Panel Toggle - when opening a panel, close the corresponding side's other menus
        function togglePanel(side) {
            const panel = document.getElementById(`${side}-panel`);
            const content = document.getElementById(`${side}PanelContent`);
            const toggle = panel.querySelector('.panel-toggle');
            const wasCollapsed = panel.classList.contains('collapsed');

            // If we're about to open this panel, close other side-specific UI
            if (wasCollapsed) {
                if (side === 'left') {
                    // opening left panel -> close filter
                    document.getElementById('filterPanel')?.classList.remove('show');
                } else if (side === 'right') {
                    // opening right panel -> close global menu
                    document.getElementById('global-menu')?.classList.remove('show');
                }
            }

            panel.classList.toggle('collapsed');
            content.classList.toggle('hidden');
            toggle.textContent = panel.classList.contains('collapsed') ? '+' : 'âˆ’';
        }

        // Menu button handler (right side)
        document.getElementById('menuButton')?.addEventListener('click', (e) => {
            e.stopPropagation();
            toggleMenu();
        });

        // Filter close button handler
        document.getElementById('filterCloseBtn')?.addEventListener('click', () => {
            document.getElementById('filterPanel').classList.remove('show');
        });

        // Panel toggle button handlers
        document.getElementById('leftPanelToggle')?.addEventListener('click', () => {
            togglePanel('left');
        });

        document.getElementById('rightPanelToggle')?.addEventListener('click', () => {
            togglePanel('right');
        });

        // Top Control Button Handlers
        document.getElementById('toggleLeftPanel')?.addEventListener('click', () => {
            togglePanel('left');
        });

        document.getElementById('toggleRightPanel')?.addEventListener('click', () => {
            togglePanel('right');
        });

        document.getElementById('toggleDrawingPanel')?.addEventListener('click', () => {
            const drawingPanel = document.getElementById('zone-draw-controls');
            if (drawingPanel) {
                drawingPanel.classList.toggle('collapsed');
            }
        });

        document.getElementById('zoomIn')?.addEventListener('click', () => {
            if (window.mapInstance) {
                window.mapInstance.map.zoomIn();
            }
        });

        document.getElementById('zoomOut')?.addEventListener('click', () => {
            if (window.mapInstance) {
                window.mapInstance.map.zoomOut();
            }
        });

        document.getElementById('mapViewToggle')?.addEventListener('click', () => {
            if (window.mapInstance) {
                const currentLayer = window.mapInstance.getCurrentLayer();
                const layerKeys = Object.keys(window.mapInstance.tileLayers);
                const currentIndex = layerKeys.findIndex(key => window.mapInstance.tileLayers[key] === currentLayer);
                const nextIndex = (currentIndex + 1) % layerKeys.length;
                window.mapInstance.setCurrentLayer(layerKeys[nextIndex]);
            }
        });

        // Filter button handler (left side)
        document.getElementById('filterBtn')?.addEventListener('click', (e) => {
            e.stopPropagation();
            const filterPanel = document.getElementById('filterPanel');
            const wasOpen = filterPanel.classList.contains('show');

            // Close left side UI (left panel) before opening filter
            closeLeftSidePanels();

            // Toggle this panel
            if (!wasOpen) {
                filterPanel.classList.add('show');
            }
        });

        // Make selection info available globally
        window.updateLeftPanel = function(data) {
            const content = document.getElementById('selection-info');
            content.innerHTML = '';
            
            for (const [label, value] of Object.entries(data)) {
                const section = document.createElement('div');
                section.className = 'info-section';
                section.innerHTML = `
                    <div class="info-label">${label}</div>
                    <div class="info-value">${value}</div>
                `;
                content.appendChild(section);
            }
        };

        // Make action buttons available globally
        window.updateRightPanel = function(buttons) {
            const content = document.getElementById('action-buttons');
            content.innerHTML = '';
            
            buttons.forEach(btn => {
                const button = document.createElement('button');
                button.className = `ios-button ${btn.class || ''}`;
                button.textContent = btn.label;
                button.onclick = btn.action;
                button.style.marginBottom = '12px';
                button.style.width = '100%';
                content.appendChild(button);
            });
        };

        // Store session data
        window.sessionData = {
            guildId: '<%= guildId %>',
            serviceId: '<%= serviceId %>',
            mapLoc: <%= mapLoc %>,
            user: <%- JSON.stringify(user) %>
        };

        // Suppress tile loading 404 errors in console
        const originalConsoleError = console.error;
        console.error = function(...args) {
            const errorStr = args.join(' ');
            // Suppress 404 errors for tile images
            if (errorStr.includes('.webp') && (errorStr.includes('404') || errorStr.includes('Not Found'))) {
                return;
            }
            originalConsoleError.apply(console, args);
        };
    </script>
</body>
</html>
